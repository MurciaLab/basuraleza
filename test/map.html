<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leaflet Map with Time Slider and Conditional Legend</title>

  <!-- Leaflet core -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.3/dist/leaflet.js"></script>

  <!-- TimeDimension CSS/JS -->
  <link rel="stylesheet" href="https://rawcdn.githack.com/socib/Leaflet.TimeDimension/v1.1.0/dist/leaflet.timedimension.control.min.css"/>
  <script src="https://rawcdn.githack.com/socib/Leaflet.TimeDimension/v1.1.0/dist/leaflet.timedimension.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>

  <!-- MarkerCluster -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.css"/>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/MarkerCluster.Default.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.1.0/leaflet.markercluster.js"></script>

  <!-- Heatmap -->
  <script src="https://cdn.jsdelivr.net/gh/Leaflet/Leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- AwesomeMarkers -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"/>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    html, body, #map { margin:0; padding:0; height:100%; width:100%; }
    /* Layer-switcher box */
    #layer-switcher {
      position: fixed; top:10px; right:10px;
      z-index:1000; background:#fff; padding:8px;
      border-radius:8px; box-shadow:0 1px 5px rgba(0,0,0,0.4);
      width:240px;
    }
    #layer-switcher .leaflet-control-layers,
    #layer-switcher .leaflet-control-layers-list {
      background:transparent!important; box-shadow:none!important;
      margin:0; padding:0;
    }
    #layer-switcher .leaflet-control-layers-overlays label {
      margin:4px 0; display:flex; align-items:center;
    }
    /* Legend box */
    #legend-container {
      position: fixed; right:10px;
      z-index:1000; background:#fff; padding:10px;
      border-radius:8px; box-shadow:0 1px 5px rgba(0,0,0,0.4);
      width:240px;
      /* top will be set dynamically */
    }
    .legend-box { margin-bottom:8px; font-size:0.9em; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="layer-switcher"></div>
  <div id="legend-container">
    <div class="legend-box" id="cluster-legend">
      <b>Tamaño de grupo</b><br>
      <span style="background:#FFA500;width:12px;height:12px;display:inline-block"></span> 1–9<br>
      <span style="background:#FF7F50;width:12px;height:12px;display:inline-block"></span> 10–29<br>
      <span style="background:#FF4500;width:12px;height:12px;display:inline-block"></span> 30–59<br>
      <span style="background:#B22222;width:12px;height:12px;display:inline-block"></span> 60+<br>
    </div>
    <div class="legend-box" id="heatmap-legend">
      <b>Densidad</b><br>
      <div style="height:12px;background:linear-gradient(to right,blue,cyan,lime,yellow,orange,red)"></div>
      <div style="display:flex;justify-content:space-between"><small>Baja</small><small>Alta</small></div>
    </div>
  </div>
  <div class="modal fade" id="imgModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content bg-transparent border-0">
        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                data-bs-dismiss="modal"></button>
        <img id="imgModalContent" class="img-fluid rounded"/>
      </div>
    </div>
  </div>

  <script>
    const map = L.map('map', {
      center:[37.96647,-1.13528], zoom:12,
      timeDimension:true,
      timeDimensionControl:true,
      timeDimensionControlOptions:{
        position:'bottomleft',
        autoPlay:false,
        loopButton:true,
        timeSliderDragUpdate:true
      }
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
      minZoom:0,maxZoom:19
    }).addTo(map);

    fetch('data/photos.json')
      .then(res=>res.json())
      .then(data=>{
        const photoCluster = L.markerClusterGroup();
        const heatPts = [];
        data.forEach(p=>{
          L.marker([p.lat,p.lng],{
            icon:L.AwesomeMarkers.icon({icon:'camera',prefix:'fa',markerColor:'blue'})
          })
          .on('click',()=>{
            document.getElementById('imgModalContent').src = p.img;
            new bootstrap.Modal(document.getElementById('imgModal')).show();
          })
          .addTo(photoCluster);
          heatPts.push([p.lat,p.lng,0.2]);
        });
        const heatLayer = L.heatLayer(heatPts,{radius:25});

        const geojson = {
          type:'FeatureCollection',
          features: data.map(p=>({
            type:'Feature',
            properties:{time:p.time,img:p.img},
            geometry:{type:'Point',coordinates:[p.lng,p.lat]}
          }))
        };
        const timeMarkers = L.geoJson(geojson,{
          pointToLayer:(feat, latlng)=>L.marker(latlng,{
            icon:L.AwesomeMarkers.icon({icon:'camera',prefix:'fa',markerColor:'green'})
          })
          .on('click',()=>{
            document.getElementById('imgModalContent').src = feat.properties.img;
            new bootstrap.Modal(document.getElementById('imgModal')).show();
          })
        });
        const tdLayer = L.timeDimension.layer.geoJson(timeMarkers,{
          updateTimeDimension:true,
          addlastPoint:false,
          duration:'PT1H'
        });

        const overlays = {
          'Fotos Geolocalizadas': photoCluster,
          'Densidad': heatLayer,
          'Time': tdLayer
        };
        const ctl = L.control.layers(null, overlays, {collapsed:false}).addTo(map);

        // move layer switcher
        const layersDiv = document.querySelector('.leaflet-control-layers');
        const layerBox = document.getElementById('layer-switcher');
        layerBox.innerHTML = '';
        layerBox.appendChild(layersDiv);

        // position legend container just below switcher
        const legendBox = document.getElementById('legend-container');
        const switcher = document.getElementById('layer-switcher');
        const top = switcher.offsetTop + switcher.offsetHeight + 4;
        legendBox.style.top = top + 'px';

        // add to map
        photoCluster.addTo(map);
        tdLayer.addTo(map);

        // update legends & container visibility
        function updateLegends() {
          const checks = document.querySelectorAll(
            '.leaflet-control-layers-overlays input[type="checkbox"]'
          );
          let showFotos = false, showDens = false;
          checks.forEach(cb => {
            const txt = cb.nextSibling.textContent;
            if (cb.checked && txt.includes('Fotos')) showFotos = true;
            if (cb.checked && txt.includes('Densidad')) showDens = true;
          });
          document.getElementById('cluster-legend').style.display = showFotos ? 'block' : 'none';
          document.getElementById('heatmap-legend').style.display  = showDens  ? 'block' : 'none';
          // hide legend container if empty
          legendBox.style.display = (showFotos || showDens) ? 'block' : 'none';
        }
        map.on('overlayadd overlayremove zoomend moveend', updateLegends);
        updateLegends();
      });
  </script>
</body>
</html>
