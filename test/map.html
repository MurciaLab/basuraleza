<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Leaflet Map with Synchronized Time-Filtered Clusters & Heatmap</title>

  <!-- Leaflet core from jsDelivr -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- TimeDimension from rawcdn.githack -->
  <link
    rel="stylesheet"
    href="https://rawcdn.githack.com/socib/Leaflet.TimeDimension/v1.1.0/dist/leaflet.timedimension.control.min.css"
  />
  <script src="https://rawcdn.githack.com/socib/Leaflet.TimeDimension/v1.1.0/dist/leaflet.timedimension.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/iso8601-js-period@0.2.1/iso8601.min.js"></script>

  <!-- MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.1.0/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.1.0/dist/MarkerCluster.Default.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.markercluster@1.1.0/dist/leaflet.markercluster.js"></script>

  <!-- Heatmap plugin -->
  <script src="https://cdn.jsdelivr.net/gh/Leaflet/Leaflet.heat/dist/leaflet-heat.js"></script>

  <!-- AwesomeMarkers -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.2/dist/leaflet.awesome-markers.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/leaflet.awesome-markers@2.0.2/dist/leaflet.awesome-markers.js"></script>

  <!-- Bootstrap -->
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css"
  />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    html, body, #map { margin:0; padding:0; height:100%; width:100%; }
    #layer-switcher {
      position:fixed; top:10px; right:10px; z-index:1000;
      background:#fff; padding:8px; border-radius:8px;
      box-shadow:0 1px 5px rgba(0,0,0,0.4); width:240px;
    }
    #layer-switcher .leaflet-control-layers,
    #layer-switcher .leaflet-control-layers-list {
      background:transparent!important; box-shadow:none!important;
      margin:0; padding:0;
    }
    #layer-switcher .leaflet-control-layers-overlays label {
      margin:4px 0; display:flex; align-items:center;
    }
    #legend-container {
      position:fixed; right:10px; z-index:1000; background:#fff;
      padding:10px; border-radius:8px; box-shadow:0 1px 5px rgba(0,0,0,0.4);
      width:240px;
    }
    .legend-box { margin-bottom:8px; font-size:0.9em; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="layer-switcher"></div>
  <div id="legend-container">
    <div class="legend-box" id="cluster-legend">
      <b>Tamaño de grupo</b><br>
      <span style="background:#FFA500;width:12px;height:12px;display:inline-block"></span> 1–9<br>
      <span style="background:#FF7F50;width:12px;height:12px;display:inline-block"></span> 10–29<br>
      <span style="background:#FF4500;width:12px;height:12px;display:inline-block"></span> 30–59<br>
      <span style="background:#B22222;width:12px;height:12px;display:inline-block"></span> 60+<br>
    </div>
    <div class="legend-box" id="heatmap-legend">
      <b>Densidad</b><br>
      <div style="height:12px;background:linear-gradient(to right,blue,cyan,lime,yellow,orange,red)"></div>
      <div style="display:flex;justify-content:space-between"><small>Baja</small><small>Alta</small></div>
    </div>
  </div>
  <div class="modal fade" id="imgModal" tabindex="-1">
    <div class="modal-dialog modal-fullscreen-sm-down modal-dialog-centered">
      <div class="modal-content bg-transparent border-0">
        <button type="button"
          class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
          data-bs-dismiss="modal"></button>
        <img id="imgModalContent" class="img-fluid rounded"/>
      </div>
    </div>
  </div>

  <script>
    // Initialize map & TimeDimension
    const map = L.map('map', {
      center: [37.96647, -1.13528], zoom:12,
      timeDimension:true,
      timeDimensionControl:true,
      timeDimensionControlOptions:{
        position:'bottomleft',
        autoPlay:false,
        loopButton:true,
        timeSliderDragUpdate:true
      }
    });
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',{
      minZoom:0,maxZoom:19
    }).addTo(map);

    // Load data and setup layers
    fetch('data/photos.json')
      .then(r => r.json())
      .then(data => {
        // Create timestamped markers and heat data
        const markers = data.map(p => {
          const m = L.marker([p.lat,p.lng], {
            icon: L.AwesomeMarkers.icon({icon:'camera',prefix:'fa',markerColor:'blue'})
          });
          m.ts = Date.parse(p.time);
          m.on('click', () => {
            document.getElementById('imgModalContent').src = p.img;
            new bootstrap.Modal(document.getElementById('imgModal')).show();
          });
          return m;
        });
        const heatPoints = data.map(p => ({
          lat: p.lat, lng: p.lng, ts: Date.parse(p.time), weight:0.2
        }));

        // Cluster group
        const clusterGroup = L.markerClusterGroup().addTo(map);

        // Heatmap layer
        const heatLayer = L.heatLayer([], {radius:25});

        // Layer control
        const overlays = {
          'Fotos Geolocalizadas': clusterGroup,
          'Densidad': heatLayer
        };
        L.control.layers(null, overlays, {collapsed:false}).addTo(map);

        // Inject layer control
        const lc = document.querySelector('.leaflet-control-layers');
        document.getElementById('layer-switcher').appendChild(lc);

        // Position legend
        const lg = document.getElementById('legend-container');
        lg.style.top = document.getElementById('layer-switcher').offsetTop +
                       document.getElementById('layer-switcher').offsetHeight + 4 + 'px';

        // Refresh both layers on time change
        function refreshAll() {
          const now = map.timeDimension.getCurrentTime();
          // clusters
          clusterGroup.clearLayers();
          markers.filter(m => m.ts <= now).forEach(m => clusterGroup.addLayer(m));
          // heat
          const pts = heatPoints.filter(pt => pt.ts <= now).map(pt => [pt.lat, pt.lng, pt.weight]);
          heatLayer.setLatLngs(pts);
          if(map.hasLayer(heatLayer)) heatLayer.redraw();
        }
        map.timeDimension.on('timedimension:change', refreshAll);
        refreshAll();

        // Legend toggle
        function updateLegends(){
          const cbs = document.querySelectorAll('.leaflet-control-layers-overlays input[type="checkbox"]');
          let showC=false, showH=false;
          cbs.forEach(cb => {
            const txt=cb.nextSibling.textContent;
            if(cb.checked && txt.includes('Fotos')) showC=true;
            if(cb.checked && txt.includes('Densidad')) showH=true;
          });
          document.getElementById('cluster-legend').style.display = showC?'block':'none';
          document.getElementById('heatmap-legend').style.display = showH?'block':'none';
          lg.style.display = (showC||showH)?'block':'none';
        }
        map.on('overlayadd overlayremove', updateLegends);
        updateLegends();
      });
  </script>
</body>
</html>
